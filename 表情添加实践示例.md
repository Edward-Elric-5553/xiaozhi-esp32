# ESP32S3 Touch LCD 1.85C 表情添加实践示例

本文档提供一个完整的实践示例，演示如何为当前使用的 `ESP32S3_Touch_LCD_1_85C` 板子添加动画表情功能。

## 当前板子分析

### 板子配置
- **板子类型**: `ESP32S3_Touch_LCD_1_85C`
- **屏幕分辨率**: 360x360
- **显示方向**: 已配置180度旋转 (MIRROR_X=true, MIRROR_Y=true)
- **当前显示类**: 使用基础的 `SpiLcdDisplay`

### 现状
当前板子使用的是基础显示类，不支持GIF动画表情，只支持文本和图标显示。

## 实施方案

我们将为这个板子添加GIF表情支持，创建一个新的表情显示类。

### 步骤1: 创建表情显示类

#### 1.1 创建头文件

在 `main/boards/esp32-s3-touch-lcd-1.85c/` 目录下创建 `emoji_display.h`:

```cpp
#pragma once

#include <libs/gif/lv_gif.h>
#include "display/lcd_display.h"

// 表情GIF资源声明
LV_IMAGE_DECLARE(neutral_360);   // 中性表情 360x360
LV_IMAGE_DECLARE(happy_360);     // 开心表情 360x360
LV_IMAGE_DECLARE(sad_360);       // 悲伤表情 360x360
LV_IMAGE_DECLARE(angry_360);     // 愤怒表情 360x360
LV_IMAGE_DECLARE(surprised_360); // 惊讶表情 360x360
LV_IMAGE_DECLARE(thinking_360);  // 思考表情 360x360

/**
 * @brief ESP32S3 Touch LCD 1.85C 表情显示类
 * 为360x360圆形屏幕优化的GIF表情显示
 */
class ESP32S3TouchLcdEmojiDisplay : public SpiLcdDisplay {
public:
    ESP32S3TouchLcdEmojiDisplay(esp_lcd_panel_io_handle_t panel_io, esp_lcd_panel_handle_t panel,
                                int width, int height, int offset_x, int offset_y, bool mirror_x,
                                bool mirror_y, bool swap_xy, DisplayFonts fonts);

    virtual ~ESP32S3TouchLcdEmojiDisplay() = default;

    // 重写表情设置方法
    virtual void SetEmotion(const char* emotion) override;

    // 重写聊天消息设置方法  
    virtual void SetChatMessage(const char* role, const char* content) override;

    // 重写图标设置方法
    virtual void SetIcon(const char* icon) override;

    // 新增方法：设置表情和消息组合显示
    void SetEmotionWithMessage(const char* emotion, const char* message);

private:
    void SetupGifContainer();
    void UpdateLayout();
    
    lv_obj_t* emotion_gif_;          ///< GIF表情组件
    lv_obj_t* message_container_;    ///< 消息容器
    bool show_message_;              ///< 是否显示消息

    // 表情映射结构
    struct EmotionMap {
        const char* name;
        const lv_image_dsc_t* gif;
    };

    static const EmotionMap emotion_maps_[];
};
```

#### 1.2 创建实现文件

在同目录下创建 `emoji_display.cc`:

```cpp
#include "emoji_display.h"

#include <esp_log.h>
#include <algorithm>
#include <cstring>
#include <string>

#include "font_awesome_symbols.h"

#define TAG "ESP32S3TouchLcdEmojiDisplay"

// 表情映射表 - 针对360x360屏幕优化
const ESP32S3TouchLcdEmojiDisplay::EmotionMap ESP32S3TouchLcdEmojiDisplay::emotion_maps_[] = {
    // 基础表情
    {"neutral", &neutral_360},
    {"default", &neutral_360},
    {"calm", &neutral_360},
    
    // 积极表情
    {"happy", &happy_360},
    {"joy", &happy_360},
    {"smile", &happy_360},
    {"laughing", &happy_360},
    {"excited", &happy_360},
    
    // 消极表情
    {"sad", &sad_360},
    {"crying", &sad_360},
    {"disappointed", &sad_360},
    
    // 愤怒表情
    {"angry", &angry_360},
    {"mad", &angry_360},
    {"furious", &angry_360},
    
    // 惊讶表情
    {"surprised", &surprised_360},
    {"shocked", &surprised_360},
    {"amazed", &surprised_360},
    
    // 思考表情
    {"thinking", &thinking_360},
    {"confused", &thinking_360},
    {"wondering", &thinking_360},
    
    {nullptr, nullptr}  // 结束标记
};

ESP32S3TouchLcdEmojiDisplay::ESP32S3TouchLcdEmojiDisplay(
    esp_lcd_panel_io_handle_t panel_io, esp_lcd_panel_handle_t panel,
    int width, int height, int offset_x, int offset_y, bool mirror_x, bool mirror_y,
    bool swap_xy, DisplayFonts fonts)
    : SpiLcdDisplay(panel_io, panel, width, height, offset_x, offset_y, mirror_x, mirror_y, swap_xy, fonts),
      emotion_gif_(nullptr),
      message_container_(nullptr),
      show_message_(false) {
    SetupGifContainer();
}

void ESP32S3TouchLcdEmojiDisplay::SetupGifContainer() {
    DisplayLockGuard lock(this);

    // 清理现有组件
    if (emotion_label_) {
        lv_obj_del(emotion_label_);
        emotion_label_ = nullptr;
    }
    if (chat_message_label_) {
        lv_obj_del(chat_message_label_);
        chat_message_label_ = nullptr;
    }
    if (content_) {
        lv_obj_del(content_);
    }

    // 创建主容器
    content_ = lv_obj_create(container_);
    lv_obj_set_scrollbar_mode(content_, LV_SCROLLBAR_MODE_OFF);
    lv_obj_set_size(content_, 360, 360);  // 圆形屏幕尺寸
    lv_obj_set_style_bg_opa(content_, LV_OPA_TRANSP, 0);
    lv_obj_set_style_border_width(content_, 0, 0);
    lv_obj_set_style_pad_all(content_, 0, 0);
    lv_obj_center(content_);

    // 创建GIF表情组件
    emotion_gif_ = lv_gif_create(content_);
    lv_obj_set_size(emotion_gif_, 360, 360);
    lv_obj_set_style_border_width(emotion_gif_, 0, 0);
    lv_obj_set_style_bg_opa(emotion_gif_, LV_OPA_TRANSP, 0);
    lv_obj_set_style_pad_all(emotion_gif_, 0, 0);
    lv_obj_center(emotion_gif_);
    lv_gif_set_src(emotion_gif_, &neutral_360);  // 默认中性表情

    // 创建消息容器（初始隐藏）
    message_container_ = lv_obj_create(content_);
    lv_obj_set_size(message_container_, 320, 80);  // 消息区域
    lv_obj_set_style_bg_opa(message_container_, LV_OPA_80, 0);
    lv_obj_set_style_bg_color(message_container_, lv_color_black(), 0);
    lv_obj_set_style_border_width(message_container_, 0, 0);
    lv_obj_set_style_radius(message_container_, 10, 0);
    lv_obj_align(message_container_, LV_ALIGN_BOTTOM_MID, 0, -20);
    lv_obj_add_flag(message_container_, LV_OBJ_FLAG_HIDDEN);

    // 创建消息文本标签
    chat_message_label_ = lv_label_create(message_container_);
    lv_label_set_text(chat_message_label_, "");
    lv_obj_set_width(chat_message_label_, 300);
    lv_label_set_long_mode(chat_message_label_, LV_LABEL_LONG_SCROLL_CIRCULAR);
    lv_obj_set_style_text_align(chat_message_label_, LV_TEXT_ALIGN_CENTER, 0);
    lv_obj_set_style_text_color(chat_message_label_, lv_color_white(), 0);
    lv_obj_set_style_text_font(chat_message_label_, &lv_font_montserrat_16, 0);
    lv_obj_center(chat_message_label_);

    // 设置深色主题
    LcdDisplay::SetTheme("dark");
    
    ESP_LOGI(TAG, "GIF容器设置完成，屏幕尺寸: 360x360");
}

void ESP32S3TouchLcdEmojiDisplay::SetEmotion(const char* emotion) {
    if (!emotion || !emotion_gif_) {
        return;
    }

    DisplayLockGuard lock(this);

    // 查找匹配的表情
    for (const auto& map : emotion_maps_) {
        if (map.name && strcmp(map.name, emotion) == 0) {
            lv_gif_set_src(emotion_gif_, map.gif);
            ESP_LOGI(TAG, "设置表情: %s", emotion);
            return;
        }
    }

    // 未找到匹配表情，使用默认中性表情
    lv_gif_set_src(emotion_gif_, &neutral_360);
    ESP_LOGI(TAG, "未知表情'%s'，使用默认中性表情", emotion);
}

void ESP32S3TouchLcdEmojiDisplay::SetChatMessage(const char* role, const char* content) {
    DisplayLockGuard lock(this);
    
    if (!chat_message_label_ || !message_container_) {
        return;
    }

    if (content == nullptr || strlen(content) == 0) {
        // 隐藏消息
        lv_obj_add_flag(message_container_, LV_OBJ_FLAG_HIDDEN);
        show_message_ = false;
        UpdateLayout();
        return;
    }

    // 显示消息
    lv_label_set_text(chat_message_label_, content);
    lv_obj_remove_flag(message_container_, LV_OBJ_FLAG_HIDDEN);
    show_message_ = true;
    UpdateLayout();

    ESP_LOGI(TAG, "设置聊天消息 [%s]: %s", role ? role : "unknown", content);
}

void ESP32S3TouchLcdEmojiDisplay::SetIcon(const char* icon) {
    if (!icon) {
        return;
    }

    DisplayLockGuard lock(this);

    // 创建图标消息
    std::string icon_message = std::string(icon) + " ";
    
    if (strcmp(icon, FONT_AWESOME_DOWNLOAD) == 0) {
        icon_message += "系统升级中...";
        SetEmotion("thinking");  // 升级时显示思考表情
    } else if (strcmp(icon, FONT_AWESOME_WIFI) == 0) {
        icon_message += "连接网络中...";
        SetEmotion("neutral");
    } else if (strcmp(icon, FONT_AWESOME_BATTERY_EMPTY) == 0) {
        icon_message += "电量不足";
        SetEmotion("sad");
    } else {
        icon_message += "系统状态";
        SetEmotion("neutral");
    }

    SetChatMessage("system", icon_message.c_str());
    ESP_LOGI(TAG, "设置图标: %s", icon);
}

void ESP32S3TouchLcdEmojiDisplay::SetEmotionWithMessage(const char* emotion, const char* message) {
    SetEmotion(emotion);
    SetChatMessage("user", message);
}

void ESP32S3TouchLcdEmojiDisplay::UpdateLayout() {
    if (!emotion_gif_) {
        return;
    }
    
    if (show_message_) {
        // 有消息时，表情稍微上移
        lv_obj_align(emotion_gif_, LV_ALIGN_CENTER, 0, -20);
    } else {
        // 无消息时，表情居中
        lv_obj_center(emotion_gif_);
    }
}
```

### 步骤2: 修改板子配置

#### 2.1 更新 `esp32_s3_touch_lcd_1_85c.cc`

找到并修改板子的主文件，将显示类从 `SpiLcdDisplay` 改为我们新创建的 `ESP32S3TouchLcdEmojiDisplay`:

```cpp
// 在文件顶部添加包含
#include "emoji_display.h"

// 在创建显示对象的地方修改
// 原来的代码：
// display = new SpiLcdDisplay(panel_io, panel, DISPLAY_WIDTH, DISPLAY_HEIGHT, 
//                            DISPLAY_OFFSET_X, DISPLAY_OFFSET_Y, DISPLAY_MIRROR_X, 
//                            DISPLAY_MIRROR_Y, DISPLAY_SWAP_XY, fonts);

// 修改为：
display = new ESP32S3TouchLcdEmojiDisplay(panel_io, panel, DISPLAY_WIDTH, DISPLAY_HEIGHT,
                                          DISPLAY_OFFSET_X, DISPLAY_OFFSET_Y, DISPLAY_MIRROR_X,
                                          DISPLAY_MIRROR_Y, DISPLAY_SWAP_XY, fonts);
```

### 步骤3: 准备GIF资源

#### 3.1 创建GIF文件

准备6个360x360的GIF文件：
- `neutral_360.gif` - 中性表情
- `happy_360.gif` - 开心表情  
- `sad_360.gif` - 悲伤表情
- `angry_360.gif` - 愤怒表情
- `surprised_360.gif` - 惊讶表情
- `thinking_360.gif` - 思考表情

#### 3.2 转换为LVGL格式

```bash
# 进入转换工具目录
cd scripts/Image_Converter

# 激活虚拟环境
venv\Scripts\activate

# 运行转换工具
python lvgl_tools_gui.py
```

在GUI中：
1. 选择GIF文件
2. 设置输出格式为 "RGB565"
3. 设置压缩为 "NONE" 或 "LZ4"
4. 点击转换

#### 3.3 整理资源文件

将转换生成的文件放入板子目录：
```
main/boards/esp32-s3-touch-lcd-1.85c/resources/
├── neutral_360.c
├── happy_360.c
├── sad_360.c
├── angry_360.c
├── surprised_360.c
└── thinking_360.c
```

### 步骤4: 配置编译

#### 4.1 确保LVGL配置

在 `sdkconfig` 中确保：
```
CONFIG_LV_USE_GIF=y
CONFIG_LV_USE_ANIMIMG=y
```

#### 4.2 更新CMakeLists.txt

如果资源文件在子目录，需要在 `main/CMakeLists.txt` 中添加：

```cmake
# 在BOARD_SOURCES部分添加
file(GLOB BOARD_SOURCES
    ${CMAKE_CURRENT_SOURCE_DIR}/boards/${BOARD_TYPE}/*.cc
    ${CMAKE_CURRENT_SOURCE_DIR}/boards/${BOARD_TYPE}/*.c
    ${CMAKE_CURRENT_SOURCE_DIR}/boards/${BOARD_TYPE}/resources/*.c
)
```

### 步骤5: 编译和测试

#### 5.1 编译项目

```bash
# 清理并编译
idf.py clean
idf.py build
```

#### 5.2 烧录和测试

```bash
# 烧录固件
idf.py flash monitor
```

#### 5.3 功能测试

通过WebSocket或代码测试表情功能：

```cpp
// 测试不同表情
display->SetEmotion("happy");
vTaskDelay(pdMS_TO_TICKS(3000));

display->SetEmotion("sad");
vTaskDelay(pdMS_TO_TICKS(3000));

display->SetEmotionWithMessage("thinking", "正在思考中...");
vTaskDelay(pdMS_TO_TICKS(3000));
```

### 步骤6: 性能优化

#### 6.1 内存优化

```cpp
// 在config.h中调整内存配置
#define DISPLAY_BUFFER_SIZE (360 * 60 * 2)  // 减少缓冲区大小
#define LV_MEM_SIZE (128 * 1024)             // 调整LVGL内存池
```

#### 6.2 显示优化

```cpp
// 在emoji_display.cc中添加性能监控
void ESP32S3TouchLcdEmojiDisplay::SetEmotion(const char* emotion) {
    uint32_t start_time = esp_timer_get_time();
    
    // ... 原有代码 ...
    
    uint32_t end_time = esp_timer_get_time();
    ESP_LOGI(TAG, "表情切换耗时: %lu us", end_time - start_time);
}
```

## 预期效果

完成以上步骤后，你的ESP32S3 Touch LCD 1.85C将具备以下功能：

1. **动画表情显示**: 支持6种基础表情的GIF动画
2. **表情映射**: 支持多种表情名称映射到相同GIF
3. **消息显示**: 支持在表情下方显示文本消息
4. **图标状态**: 支持系统状态图标显示
5. **布局自适应**: 根据是否有消息自动调整布局

## 故障排除

### 常见问题

1. **编译错误**: 检查头文件包含和CMakeLists.txt配置
2. **显示异常**: 确认GIF文件格式和LVGL配置
3. **内存不足**: 减少GIF文件大小或调整内存配置
4. **性能问题**: 降低GIF帧率或分辨率

### 调试方法

```cpp
// 添加调试日志
#define TAG "EmojiDisplay"
ESP_LOGI(TAG, "Free heap: %d", esp_get_free_heap_size());
ESP_LOGI(TAG, "LVGL memory usage: %d%%", lv_mem_get_used_pct());
```

通过这个完整的实践示例，你可以为当前的ESP32S3 Touch LCD 1.85C板子成功添加动画表情功能。